<!DOCTYPE html>
<html>
<head>
    <title>Fleet Software Manager - Fleet Management</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
        .nav-menu { background: #2c3e50; padding: 0; margin: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-menu ul { list-style: none; margin: 0; padding: 0; display: flex; flex-wrap: wrap; }
        .nav-menu li { margin: 0; }
        .nav-menu a { display: block; padding: 15px 20px; color: white; text-decoration: none; transition: background 0.3s; }
        .nav-menu a:hover { background: #34495e; }
        .nav-menu a.active { background: #34495e; }
        .app-layout { display: flex; min-height: calc(100vh - 52px); }
        .sidebar { width: 15%; background: #2c3e50; color: white; padding: 20px; box-sizing: border-box; position: sticky; top: 0; height: calc(100vh - 52px); overflow-y: auto; }
        .sidebar h3 { margin-top: 0; font-size: 16px; border-bottom: 2px solid #34495e; padding-bottom: 10px; }
        .sidebar .menu-item { display: block; padding: 12px; background: #34495e; color: white; text-decoration: none; border-radius: 4px; margin-bottom: 8px; cursor: pointer; transition: background 0.3s; }
        .sidebar .menu-item:hover { background: #7f8c8d; }
        .sidebar .menu-item.active { background: #27ae60; font-weight: bold; }
        .main-content-wrapper { width: 70%; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .right-sidebar { width: 15%; background: #2c3e50; color: white; padding: 20px; box-sizing: border-box; position: sticky; top: 0; height: calc(100vh - 52px); overflow-y: auto; }
        .right-sidebar .login-section { background: #34495e; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .right-sidebar .login-section input { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #95a5a6; border-radius: 4px; box-sizing: border-box; }
        .right-sidebar .role-switcher { margin-top: 15px; padding: 10px; background: #34495e; border-radius: 8px; display: none; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-value { font-size: 2em; font-weight: bold; color: #34495e; }
        .stat-label { color: #666; margin-top: 5px; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-height: calc(100vh - 150px); overflow-y: auto; }
        .tabs { display: flex; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 8px 15px; background: #bdc3c7; color: #333; cursor: pointer; border: none; margin: 2px; font-size: 12px; }
        .tab.active { background: #34495e; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn { background: #34495e; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #2c3e50; }
        .btn-secondary { background: #95a5a6; }
        .btn-success { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        .data-table th, .data-table td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        .data-table th { background-color: #f8f9fa; font-weight: bold; }
        .data-table tr:hover { background-color: #f5f5f5; }
        .result { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 10px; border-left: 4px solid #34495e; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .version-badge { background: #3498db; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; }
        .status-badge { padding: 2px 6px; border-radius: 3px; font-size: 10px; color: white; }
        .status-installed { background: #27ae60; }
        .status-pending { background: #f39c12; }
        .status-failed { background: #e74c3c; }
        .category-badge { background: #9b59b6; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; }
    </style>
</head>
<body>
    <nav class="nav-menu">
        <ul>
            <li><a href="/">üè† Home</a></li>
            <li><a href="/connect-plus">üîó Connect++</a></li>
            <li><a href="/connect-display">üñ•Ô∏è Connect Display</a></li>
            <li><a href="/connect-manager">‚öôÔ∏è Connect Manager</a></li>
            <li><a href="/fleet-data-manager">üìä Fleet Data Manager</a></li>
            <li><a href="/fleet-config-manager">üîß Fleet Config Manager</a></li>
            <li><a href="/fleet-software-manager" class="active">üíø Fleet Software Manager</a></li>
            <li><a href="/docs">üìö API Docs</a></li>
        </ul>
    </nav>
    <div class="app-layout">
        <div class="sidebar">
            <h3>üíø Menu Modu≈Çu</h3>
            <div class="menu-item" onclick="scrollToSection('dashboard')">üìä Dashboard</div>
            <div class="menu-item active" onclick="showTab('software-tab', this)">üì¶ Oprogramowanie</div>
            <div class="menu-item" onclick="showTab('versions-tab', this)">üî¢ Wersje</div>
            <div class="menu-item" onclick="showTab('installations-tab', this)">üíæ Instalacje</div>
            
            <div style="margin-top: 20px; padding: 10px; background: #374151; border-radius: 8px;">
                <h4 style="margin-top: 0; font-size: 14px; border-bottom: 2px solid #27ae60; padding-bottom: 8px;">üîç API Test</h4>
                <button class="btn btn-secondary" style="width: 100%; margin-bottom: 5px; font-size: 12px;" onclick="testSoftwareAPI()">Test Software</button>
                <button class="btn btn-secondary" style="width: 100%; margin-bottom: 5px; font-size: 12px;" onclick="testVersionsAPI()">Test Versions</button>
                <button class="btn btn-secondary" style="width: 100%; margin-bottom: 5px; font-size: 12px;" onclick="testInstallationsAPI()">Test Installations</button>
                <button class="btn btn-secondary" style="width: 100%; font-size: 12px;" onclick="testDashboard()">Test Dashboard</button>
            </div>
        </div>

        <div class="main-content-wrapper">
        <div id="dashboard" class="dashboard">
            <div class="stat-card">
                <div class="stat-value" id="total-software">-</div>
                <div class="stat-label">Ca≈Çkowite oprogramowanie</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-versions">-</div>
                <div class="stat-label">Wersje oprogramowania</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="devices-with-software">-</div>
                <div class="stat-label">UrzƒÖdzenia z oprogramowaniem</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="recent-installations">-</div>
                <div class="stat-label">Dzisiejsze instalacje</div>
            </div>
        </div>

        <div class="section">
            <div class="tabs">
                <button class="tab active" onclick="showTab('software-tab', this)">Oprogramowanie</button>
                <button class="tab" onclick="showTab('versions-tab', this)">Wersje</button>
                <button class="tab" onclick="showTab('installations-tab', this)">Instalacje</button>
            </div>

            <div id="software-tab" class="tab-content active">
                <h3>üì¶ ZarzƒÖdzanie Oprogramowaniem</h3>
                <button class="btn" onclick="loadSoftware()">Od≈õwie≈º listƒô</button>
                <button class="btn btn-success" onclick="showCreateSoftwareForm()">Dodaj oprogramowanie</button>
                <div id="software-list"><p>Kliknij "Od≈õwie≈º listƒô"</p></div>

                <div id="create-software-form" style="display: none; margin-top: 20px; padding: 20px; border: 2px solid #34495e; border-radius: 8px;">
                    <h4>‚ûï Dodaj nowe oprogramowanie</h4>
                    <div class="form-group"><label>Nazwa:</label><input type="text" id="software-name" required></div>
                    <div class="form-group"><label>Opis:</label><textarea id="software-description" rows="3"></textarea></div>
                    <div class="form-group"><label>Dostawca:</label><input type="text" id="software-vendor"></div>
                    <div class="form-group">
                        <label>Kategoria:</label>
                        <select id="software-category">
                            <option value="">Wybierz kategoriƒô</option>
                            <option value="firmware">Firmware</option>
                            <option value="application">Aplikacja</option>
                            <option value="driver">Driver</option>
                            <option value="tool">Narzƒôdzie</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Platforma:</label><input type="text" id="software-platform"></div>
                    <div class="form-group"><label>URL repozytorium:</label><input type="url" id="software-repository"></div>
                    <button class="btn btn-success" onclick="createSoftware()">Utw√≥rz</button>
                    <button class="btn btn-secondary" onclick="hideCreateSoftwareForm()">Anuluj</button>
                </div>
            </div>

            <div id="versions-tab" class="tab-content">
                <h3>üî¢ ZarzƒÖdzanie Wersjami</h3>
                <div class="form-group">
                    <label>Wybierz oprogramowanie:</label>
                    <select id="version-software-select" onchange="loadVersions()">
                        <option value="">-- Wybierz oprogramowanie --</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="showCreateVersionForm()" id="add-version-btn" style="display: none;">Dodaj wersjƒô</button>
                <div id="versions-list"><p>Wybierz oprogramowanie</p></div>

                <div id="create-version-form" style="display: none; margin-top: 20px; padding: 20px; border: 2px solid #34495e; border-radius: 8px;">
                    <h4>‚ûï Dodaj nowƒÖ wersjƒô</h4>
                    <div class="form-group"><label>Numer wersji:</label><input type="text" id="version-number" required></div>
                    <div class="form-group"><label>Notatki:</label><textarea id="version-release-notes" rows="3"></textarea></div>
                    <div class="form-group"><label>URL:</label><input type="url" id="version-download-url"></div>
                    <div style="display: flex; gap: 20px;">
                        <label><input type="checkbox" id="version-stable" checked> Stabilna</label>
                        <label><input type="checkbox" id="version-beta"> Beta</label>
                        <label><input type="checkbox" id="version-reboot"> Restart</label>
                    </div><br>
                    <button class="btn btn-success" onclick="createVersion()">Utw√≥rz wersjƒô</button>
                    <button class="btn btn-secondary" onclick="hideCreateVersionForm()">Anuluj</button>
                </div>
            </div>

            <div id="installations-tab" class="tab-content">
                <h3>‚öôÔ∏è Historia Instalacji</h3>
                <button class="btn" onclick="loadInstallations()">Od≈õwie≈º listƒô</button>
                <button class="btn btn-success" onclick="showInstallationForm()">Nowa instalacja</button>
                <div id="installations-list"><p>Kliknij "Od≈õwie≈º listƒô"</p></div>

                <div id="installation-form" style="display: none; margin-top: 20px; padding: 20px; border: 2px solid #34495e; border-radius: 8px;">
                    <h4>‚öôÔ∏è Nowa instalacja</h4>
                    <div class="form-group">
                        <label>UrzƒÖdzenie:</label>
                        <select id="installation-device" required><option value="">-- Wybierz --</option></select>
                    </div>
                    <div class="form-group">
                        <label>Wersja:</label>
                        <select id="installation-version" required><option value="">-- Wybierz --</option></select>
                    </div>
                    <div class="form-group">
                        <label>Akcja:</label>
                        <select id="installation-action" required>
                            <option value="install">Instaluj</option>
                            <option value="update">Aktualizuj</option>
                            <option value="uninstall">Odinstaluj</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Notatki:</label><textarea id="installation-notes" rows="3"></textarea></div>
                    <button class="btn btn-success" onclick="createInstallation()">Rozpocznij</button>
                    <button class="btn btn-secondary" onclick="hideInstallationForm()">Anuluj</button>
                </div>
            </div>
        </div>
        <div id="result" style="margin-top: 20px;"></div>
    </div>
    
    <div class="right-sidebar">
        <h3>üîê Logowanie</h3>
        <div class="login-section">
            <input type="text" id="login-username" placeholder="Username">
            <input type="password" id="login-password" placeholder="Password">
            <button class="btn btn-success" onclick="login()">Zaloguj</button>
            <button class="btn btn-danger" onclick="logout()" style="display: none;" id="logout-btn">Wyloguj</button>
            <div id="auth-message" style="margin-top: 10px; font-size: 12px;"></div>
        </div>
        <div class="role-switcher" id="role-switcher">
            <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #ecf0f1;">üîÑ Prze≈ÇƒÖcz rolƒô:</label>
            <select id="role-select" onchange="switchRole()"><option value="">Wybierz...</option></select>
        </div>
    </div>
</div>
<script>
    let authToken = null;
    let currentSoftwareId = null;
    let softwareList = [];

    function getAuthToken() {
        if (!authToken) {
            authToken = localStorage.getItem('jwt_token');
        }
        return authToken;
    }

    function setAuthToken(token) {
        authToken = token;
        localStorage.setItem('jwt_token', token);
        updateAuthUI();
    }

    function clearAuthToken() {
        authToken = null;
        localStorage.removeItem('jwt_token');
        updateAuthUI();
    }

    function updateAuthUI() {
        const isLoggedIn = !!getAuthToken();
        document.getElementById('login-username').style.display = isLoggedIn ? 'none' : 'inline';
        document.getElementById('login-password').style.display = isLoggedIn ? 'none' : 'inline';
        document.querySelector('button[onclick="login()"]').style.display = isLoggedIn ? 'none' : 'inline';
        document.getElementById('logout-btn').style.display = isLoggedIn ? 'inline' : 'none';
        
        if (isLoggedIn) {
            const userRoles = getUserRoles();
            const activeRole = getActiveRole();
            document.getElementById('auth-message').innerHTML = `<span style="color: #27ae60;">‚úÖ Zalogowany jako <strong>${activeRole}</strong></span>`;
            
            if (userRoles && userRoles.length > 1) {
                const roleSelect = document.getElementById('role-select');
                roleSelect.innerHTML = '<option value="">Wybierz rolƒô...</option>';
                userRoles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role;
                    option.textContent = role.charAt(0).toUpperCase() + role.slice(1);
                    if (role === activeRole) option.selected = true;
                    roleSelect.appendChild(option);
                });
                document.getElementById('role-switcher').style.display = 'block';
            } else {
                document.getElementById('role-switcher').style.display = 'none';
            }
            loadDashboard();
        } else {
            document.getElementById('auth-message').innerHTML = '<span style="color: #e74c3c;">‚ùå Niezalogowany</span>';
            document.getElementById('role-switcher').style.display = 'none';
        }
    }

    function getUserRoles() {
        const token = getAuthToken();
        if (!token) return [];
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.roles || [];
        } catch (e) {
            return [];
        }
    }

    function getActiveRole() {
        const token = getAuthToken();
        if (!token) return '';
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.active_role || payload.role || '';
        } catch (e) {
            return '';
        }
    }

    async function switchRole() {
        const selectedRole = document.getElementById('role-select').value;
        if (!selectedRole) return;
        try {
            const response = await fetch('/api/v1/auth/switch-role', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getAuthToken()}` },
                body: JSON.stringify({ new_role: selectedRole })
            });
            if (response.ok) {
                const data = await response.json();
                setAuthToken(data.access_token);
                document.getElementById('auth-message').innerHTML = `<span style="color: #27ae60;">‚úÖ Prze≈ÇƒÖczono na rolƒô: <strong>${selectedRole}</strong></span>`;
                loadDashboard();
            } else {
                const error = await response.json();
                document.getElementById('auth-message').innerHTML = `<span style="color: #e74c3c;">‚ùå B≈ÇƒÖd: ${error.detail}</span>`;
            }
        } catch (error) {
            document.getElementById('auth-message').innerHTML = `<span style="color: #e74c3c;">‚ùå B≈ÇƒÖd: ${error.message}</span>`;
        }
    }

    function scrollToSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
        }
    }

    async function login() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        if (!username || !password) { alert('Podaj username i has≈Ço'); return; }

        try {
            const formData = new URLSearchParams();
            formData.append('username', username);
            formData.append('password', password);
            const response = await fetch('/api/v1/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });
            if (response.ok) {
                const data = await response.json();
                setAuthToken(data.access_token);
                document.getElementById('login-password').value = '';
                document.getElementById('result').innerHTML = `<div class="result">‚úÖ Zalogowano jako ${username}</div>`;
            } else {
                const error = await response.json();
                document.getElementById('auth-message').innerHTML = `<span style="color: #e74c3c;">‚ùå B≈ÇƒÖd: ${error.detail}</span>`;
            }
        } catch (error) {
            document.getElementById('auth-message').innerHTML = `<span style="color: #e74c3c;">‚ùå B≈ÇƒÖd: ${error.message}</span>`;
        }
    }

    function logout() {
        clearAuthToken();
        document.getElementById('login-username').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('software-list').innerHTML = '<p>Zaloguj siƒô aby zobaczyƒá oprogramowanie...</p>';
        document.getElementById('result').innerHTML = '<div class="result">‚ÑπÔ∏è Wylogowano</div>';
    }

    async function makeAuthenticatedRequest(url, options = {}) {
        const token = getAuthToken();
        try {
            return await fetch(url, {
                ...options,
                headers: { 'Content-Type': 'application/json', ...(token && { 'Authorization': `Bearer ${token}` }), ...options.headers }
            });
        } catch (error) {
            console.error('Request failed:', error);
            throw error;
        }
    }

    function showTab(tabId, tabButton) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if (tabButton) tabButton.classList.add('active');
    }

    async function loadDashboard() {
        if (!getAuthToken()) return;
        try {
            const response = await makeAuthenticatedRequest('/api/v1/fleet-software/dashboard/stats');
            if (response.status === 401 || response.status === 403) { clearAuthToken(); return; }
            const stats = await response.json();
            document.getElementById('total-software').textContent = stats.total_software || 0;
            document.getElementById('total-versions').textContent = stats.total_versions || 0;
            document.getElementById('devices-with-software').textContent = stats.devices_with_software || 0;
            document.getElementById('recent-installations').textContent = stats.recent_installations || 0;
        } catch (error) {
            console.error('Failed to load dashboard:', error);
        }
    }

    async function loadSoftware() {
        if (!getAuthToken()) {
            document.getElementById('software-list').innerHTML = '<div style="color: #95a5a6; padding: 10px;">üí° Zaloguj siƒô</div>';
            return;
        }
        try {
            const response = await makeAuthenticatedRequest('/api/v1/fleet-software/software');
            if (response.status === 401 || response.status === 403) {
                document.getElementById('software-list').innerHTML = '<div style="color: #e74c3c;">‚ùå Brak autoryzacji</div>';
                clearAuthToken();
                return;
            }
            softwareList = await response.json();
            displaySoftware(softwareList);
            populateSoftwareSelect();
        } catch (error) {
            document.getElementById('result').innerHTML = `<div class="result">B≈ÇƒÖd: ${error.message}</div>`;
        }
    }

    function displaySoftware(software) {
        const container = document.getElementById('software-list');
        if (software.length === 0) {
            container.innerHTML = '<p>Brak oprogramowania.</p>';
            return;
        }
        let html = '<table class="data-table"><thead><tr><th>Nazwa</th><th>Kategoria</th><th>Dostawca</th><th>Platforma</th><th>Wersje</th><th>Najnowsza</th><th>Akcje</th></tr></thead><tbody>';
        software.forEach(sw => {
            html += `<tr>
                <td><strong>${sw.name}</strong><br><small>${sw.description || ''}</small></td>
                <td><span class="category-badge">${sw.category}</span></td>
                <td>${sw.vendor || '-'}</td>
                <td>${sw.platform || '-'}</td>
                <td>${sw.versions_count}</td>
                <td><span class="version-badge">${sw.latest_version || 'Brak'}</span></td>
                <td>
                    <button class="btn btn-secondary" onclick="viewSoftware(${sw.id})" style="font-size: 10px; padding: 5px;">Zobacz</button>
                    <button class="btn btn-danger" onclick="deleteSoftware(${sw.id})" style="font-size: 10px; padding: 5px;">Usu≈Ñ</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function populateSoftwareSelect() {
        const select = document.getElementById('version-software-select');
        select.innerHTML = '<option value="">-- Wybierz oprogramowanie --</option>';
        softwareList.forEach(sw => {
            select.innerHTML += `<option value="${sw.id}">${sw.name} (${sw.category})</option>`;
        });
        loadDevicesForInstallation();
        loadVersionsForInstallation();
    }

    async function loadDevicesForInstallation() {
        try {
            const response = await makeAuthenticatedRequest('/api/v1/devices');
            const data = await response.json();
            const select = document.getElementById('installation-device');
            select.innerHTML = '<option value="">-- Wybierz urzƒÖdzenie --</option>';
            if (data.devices) {
                data.devices.forEach(device => {
                    select.innerHTML += `<option value="${device.id}">${device.device_number} (${device.device_type})</option>`;
                });
            }
        } catch (error) {
            console.error('Failed to load devices:', error);
        }
    }

    async function loadVersionsForInstallation() {
        const select = document.getElementById('installation-version');
        select.innerHTML = '<option value="">-- Wybierz wersjƒô --</option>';
        for (const sw of softwareList) {
            try {
                const response = await makeAuthenticatedRequest(`/api/v1/fleet-software/software/${sw.id}/versions`);
                const versions = await response.json();
                versions.forEach(version => {
                    select.innerHTML += `<option value="${version.id}">${sw.name} v${version.version_number}</option>`;
                });
            } catch (error) {
                console.error(`Failed to load versions for ${sw.name}:`, error);
            }
        }
    }

    function showCreateSoftwareForm() { document.getElementById('create-software-form').style.display = 'block'; }
    function hideCreateSoftwareForm() {
        document.getElementById('create-software-form').style.display = 'none';
        document.getElementById('software-name').value = '';
        document.getElementById('software-description').value = '';
        document.getElementById('software-vendor').value = '';
        document.getElementById('software-category').value = '';
        document.getElementById('software-platform').value = '';
        document.getElementById('software-repository').value = '';
    }

    async function createSoftware() {
        const softwareData = {
            name: document.getElementById('software-name').value,
            description: document.getElementById('software-description').value,
            vendor: document.getElementById('software-vendor').value,
            category: document.getElementById('software-category').value,
            platform: document.getElementById('software-platform').value,
            repository_url: document.getElementById('software-repository').value,
            is_active: true
        };
        if (!softwareData.name || !softwareData.category) { alert('Podaj nazwƒô i kategoriƒô'); return; }

        try {
            const response = await makeAuthenticatedRequest('/api/v1/fleet-software/software', {
                method: 'POST',
                body: JSON.stringify(softwareData)
            });
            if (response.ok) {
                const result = await response.json();
                document.getElementById('result').innerHTML = `<div class="result">‚úÖ Utworzono '${result.name}'</div>`;
                hideCreateSoftwareForm();
                loadSoftware();
            } else {
                const error = await response.json();
                document.getElementById('result').innerHTML = `<div class="result">‚ùå B≈ÇƒÖd: ${error.detail}</div>`;
            }
        } catch (error) {
            document.getElementById('result').innerHTML = `<div class="result">‚ùå B≈ÇƒÖd: ${error.message}</div>`;
        }
    }

    async function viewSoftware(softwareId) {
        const software = softwareList.find(s => s.id === softwareId);
        if (!software) return;
        document.getElementById('result').innerHTML = `
            <div class="result" style="background: #e8f5e9; border-color: #4caf50;">
                <h4>üì¶ ${software.name}</h4>
                <p><strong>Kategoria:</strong> ${software.category}</p>
                <p><strong>Vendor:</strong> ${software.vendor || 'Brak'}</p>
                <p><strong>Platforma:</strong> ${software.platform || 'Brak'}</p>
                <p><strong>Opis:</strong> ${software.description || 'Brak'}</p>
            </div>
        `;
    }

    async function deleteSoftware(softwareId) {
        if (!confirm('Czy na pewno chcesz usunƒÖƒá to oprogramowanie?')) return;
        try {
            const response = await makeAuthenticatedRequest(`/api/v1/fleet-software/software/${softwareId}`, { method: 'DELETE' });
            if (response.ok) {
                document.getElementById('result').innerHTML = '<div class="result">‚úÖ Usuniƒôto</div>';
                loadSoftware();
                loadDashboard();
            } else {
                const error = await response.json();
                document.getElementById('result').innerHTML = `<div class="result">‚ùå B≈ÇƒÖd: ${error.detail}</div>`;
            }
        } catch (error) {
            document.getElementById('result').innerHTML = `<div class="result">‚ùå B≈ÇƒÖd: ${error.message}</div>`;
        }
    }

    async function loadVersions() {
        const softwareId = document.getElementById('version-software-select').value;
        if (!softwareId) {
            document.getElementById('versions-list').innerHTML = '<p>Wybierz oprogramowanie</p>';
            document.getElementById('add-version-btn').style.display = 'none';
            return;
        }
        currentSoftwareId = softwareId;
        document.getElementById('add-version-btn').style.display = 'inline';
        try {
            const response = await makeAuthenticatedRequest(`/api/v1/fleet-software/software/${softwareId}/versions`);
            const versions = await response.json();
            displayVersions(versions);
        } catch (error) {
            document.getElementById('result').innerHTML = `<div class="result">‚ùå B≈ÇƒÖd: ${error.message}</div>`;
        }
    }

    function displayVersions(versions) {
        const container = document.getElementById('versions-list');
        if (versions.length === 0) {
            container.innerHTML = '<p>Brak wersji.</p>';
            return;
        }
        let html = '<table class="data-table"><thead><tr><th>Wersja</th><th>Typ</th><th>Instalacje</th><th>Utworzono</th><th>Akcje</th></tr></thead><tbody>';
        versions.forEach(version => {
            const badges = [];
            if (version.is_stable) badges.push('<span class="status-badge status-installed">Stabilna</span>');
            if (version.is_beta) badges.push('<span class="status-badge" style="background: #f39c12;">Beta</span>');
            if (version.requires_reboot) badges.push('<span class="status-badge" style="background: #e67e22;">Restart</span>');
            html += `<tr>
                <td><strong>${version.version_number}</strong><br><small>${version.release_notes || ''}</small></td>
                <td>${badges.join(' ')}</td>
                <td>${version.installations_count}</td>
                <td>${new Date(version.created_at).toLocaleDateString()}</td>
                <td><button class="btn btn-secondary" onclick="viewVersion(${version.id})" style="font-size: 10px; padding: 5px;">Zobacz</button></td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function showCreateVersionForm() {
        if (!currentSoftwareId) { alert('Wybierz oprogramowanie'); return; }
        document.getElementById('create-version-form').style.display = 'block';
    }

    function hideCreateVersionForm() {
        document.getElementById('create-version-form').style.display = 'none';
        document.getElementById('version-number').value = '';
        document.getElementById('version-release-notes').value = '';
        document.getElementById('version-download-url').value = '';
        document.getElementById('version-stable').checked = true;
        document.getElementById('version-beta').checked = false;
        document.getElementById('version-reboot').checked = false;
    }

    async function createVersion() {
        if (!currentSoftwareId) { alert('Wybierz oprogramowanie'); return; }
        const versionData = {
            software_id: currentSoftwareId,
            version_number: document.getElementById('version-number').value,
            release_notes: document.getElementById('version-release-notes').value,
            download_url: document.getElementById('version-download-url').value,
            is_stable: document.getElementById('version-stable').checked,
            is_beta: document.getElementById('version-beta').checked,
            requires_reboot: document.getElementById('version-reboot').checked
        };
        if (!versionData.version_number) { alert('Podaj numer wersji'); return; }

        try {
            const response = await makeAuthenticatedRequest(`/api/v1/fleet-software/software/${currentSoftwareId}/versions`, {
                method: 'POST',
                body: JSON.stringify(versionData)
            });
            if (response.ok) {
                const result = await response.json();
                document.getElementById('result').innerHTML = `<div class="result">‚úÖ Utworzono wersjƒô '${result.version_number}'</div>`;
                hideCreateVersionForm();
                loadVersions();
                loadSoftware();
            } else {
                const error = await response.json();
                document.getElementById('result').innerHTML = `<div class="result">‚ùå B≈ÇƒÖd: ${error.detail}</div>`;
            }
        } catch (error) {
            document.getElementById('result').innerHTML = `<div class="result">‚ùå B≈ÇƒÖd: ${error.message}</div>`;
        }
    }

    async function loadInstallations() {
        if (!getAuthToken()) {
            document.getElementById('installations-list').innerHTML = '<div style="color: #95a5a6;">üí° Zaloguj siƒô</div>';
            return;
        }
        try {
            const response = await makeAuthenticatedRequest('/api/v1/fleet-software/installations');
            if (response.status === 401 || response.status === 403) {
                document.getElementById('installations-list').innerHTML = '<div style="color: #e74c3c;">‚ùå Brak autoryzacji</div>';
                clearAuthToken();
                return;
            }
            const installations = await response.json();
            displayInstallations(installations);
        } catch (error) {
            document.getElementById('result').innerHTML = `<div class="result">B≈ÇƒÖd: ${error.message}</div>`;
        }
    }

    function displayInstallations(installations) {
        const container = document.getElementById('installations-list');
        if (installations.length === 0) {
            container.innerHTML = '<p>Brak historii instalacji.</p>';
            return;
        }
        let html = '<table class="data-table"><thead><tr><th>UrzƒÖdzenie</th><th>Oprogramowanie</th><th>Akcja</th><th>Status</th><th>Data</th></tr></thead><tbody>';
        installations.forEach(installation => {
            const statusClass = installation.status === 'completed' ? 'status-installed' : installation.status === 'pending' ? 'status-pending' : 'status-failed';
            html += `<tr>
                <td>${installation.device_number}</td>
                <td><strong>${installation.software_name}</strong><br><small>v${installation.version_number}</small></td>
                <td>${installation.action}</td>
                <td><span class="status-badge ${statusClass}">${installation.status}</span></td>
                <td>${new Date(installation.started_at).toLocaleString()}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function showInstallationForm() { document.getElementById('installation-form').style.display = 'block'; }
    function hideInstallationForm() {
        document.getElementById('installation-form').style.display = 'none';
        document.getElementById('installation-device').value = '';
        document.getElementById('installation-version').value = '';
        document.getElementById('installation-action').value = 'install';
        document.getElementById('installation-notes').value = '';
    }

    async function createInstallation() {
        const installationData = {
            device_id: parseInt(document.getElementById('installation-device').value),
            version_id: parseInt(document.getElementById('installation-version').value),
            action: document.getElementById('installation-action').value,
            notes: document.getElementById('installation-notes').value
        };
        if (!installationData.device_id || !installationData.version_id || !installationData.action) {
            alert('Wype≈Çnij wszystkie pola');
            return;
        }

        try {
            const response = await makeAuthenticatedRequest('/api/v1/fleet-software/installations', {
                method: 'POST',
                body: JSON.stringify(installationData)
            });
            if (response.ok) {
                const result = await response.json();
                document.getElementById('result').innerHTML = `<div class="result">‚úÖ Instalacja rozpoczƒôta na ${result.device_number}</div>`;
                hideInstallationForm();
                loadInstallations();
                loadDashboard();
            } else {
                const error = await response.json();
                document.getElementById('result').innerHTML = `<div class="result">‚ùå B≈ÇƒÖd: ${error.detail}</div>`;
            }
        } catch (error) {
            document.getElementById('result').innerHTML = `<div class="result">‚ùå B≈ÇƒÖd: ${error.message}</div>`;
        }
    }

    // API Testing
    async function testSoftwareAPI() {
        try {
            const response = await makeAuthenticatedRequest('/api/v1/fleet-software/software');
            const data = await response.json();
            document.getElementById('result').innerHTML = `<div class="result">Test Software API\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}</div>`;
        } catch (error) {
            document.getElementById('result').innerHTML = `<div class="result">Error: ${error.message}</div>`;
        }
    }

    async function testVersionsAPI() {
        if (softwareList.length > 0) {
            const softwareId = softwareList[0].id;
            try {
                const response = await makeAuthenticatedRequest(`/api/v1/fleet-software/software/${softwareId}/versions`);
                const data = await response.json();
                document.getElementById('result').innerHTML = `<div class="result">Test Versions API\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}</div>`;
            } catch (error) {
                document.getElementById('result').innerHTML = `<div class="result">Error: ${error.message}</div>`;
            }
        } else {
            document.getElementById('result').innerHTML = '<div class="result">‚ùå Brak oprogramowania</div>';
        }
    }

    async function testInstallationsAPI() {
        try {
            const response = await makeAuthenticatedRequest('/api/v1/fleet-software/installations');
            const data = await response.json();
            document.getElementById('result').innerHTML = `<div class="result">Test Installations API\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}</div>`;
        } catch (error) {
            document.getElementById('result').innerHTML = `<div class="result">Error: ${error.message}</div>`;
        }
    }

    async function testDashboard() {
        try {
            const response = await makeAuthenticatedRequest('/api/v1/fleet-software/dashboard/stats');
            const data = await response.json();
            document.getElementById('result').innerHTML = `<div class="result">Test Dashboard\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}</div>`;
        } catch (error) {
            document.getElementById('result').innerHTML = `<div class="result">Error: ${error.message}</div>`;
        }
    }

    // Initialize on load
    window.addEventListener('DOMContentLoaded', function() {
        updateAuthUI();
    });
</script>
</body>
</html>
